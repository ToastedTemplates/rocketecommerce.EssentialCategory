@inherits RocketEcommerce.Components.RocketEcommerceTokens<Simplisity.SimplisityRazor>
@using DNNrocketAPI;
@using Simplisity;
@using RocketEcommerce.Components;
@using DNNrocketAPI.Components;

@{
    var portalShop = (PortalShopLimpet)Model.List.First();
    var remoteParam = (RemoteLimpet)Model.GetDataObject("remoteparam");
    var productData = (ProductLimpet)Model.GetDataObject("productdata");
    var sessionParams = (SessionParams)Model.SessionParamsData;
}

@if (productData != null)
{
    <meta name="keywords" content="@productData.Keywords.Replace("\"","")">

    var productImg = "";
    var img = productData.GetImage(0);
    if (img != null)
    {
        productImg = img.RelPath;
    }
    <!-- JSON-LD markup generated by Google's structured data markup help tool -->
    <script type="application/ld+json">
        {
        "@@context" : "http://schema.org",
        "@@type" : "Product",
        "name" : "@(productData.Name.Replace("\"", ""))",
        "image" : "@(portalShop.EngineUrlWithProtocol)@(productImg)",
        "description" : "@(productData.Summary.Replace("\"", ""))",
        "url" : "@productData.UrlTokens(portalShop.ProductDetailPageUrl)",
        "brand" : {
        "@@type" : "Brand",
        "name" : "@(productData.Brand.Replace("\"", ""))"
        },
        "offers" : {
        "@@type" : "Offer",
        "price" : "@(productData.BestPriceDisplay(remoteParam.CultureCode))",
        "priceCurrency": "@portalShop.CurrencyCode"
        }
        }
    </script>

}


<link rel="stylesheet" href="@(remoteParam.EngineURL)@DNNrocketUtils.AppendFileModifiedDate("/DesktopModules/DNNrocket/API/Themes/config-w3/1.0/css/" + portalShop.ColorTheme)">
<script type="text/javascript" src="@(remoteParam.EngineURL)@DNNrocketUtils.AppendFileModifiedDate("/DesktopModules/DNNrocket/Simplisity/js/simplisity.js")"></script>
<script type="text/javascript" src="@(remoteParam.EngineURL)@DNNrocketUtils.AppendFileModifiedDate("/DesktopModules/RocketThemes/" + portalShop.AppTheme.AppThemeFolder + "/" + portalShop.AppTheme.AppVersionFolder + "/js/frontend.js")"></script>
<link rel="stylesheet" href="@(remoteParam.EngineURL)@DNNrocketUtils.AppendFileModifiedDate("/DesktopModules/RocketThemes/" + portalShop.AppTheme.AppThemeFolder + "/" + portalShop.AppTheme.AppVersionFolder + "/css/theme.css")">
<script type="text/javascript" src="@(remoteParam.EngineURL)@DNNrocketUtils.AppendFileModifiedDate("/DesktopModules/DNNrocket/js/jquery.validate.min.js")"></script>

@if (DNNrocketUtils.GetLanguageCode(remoteParam.CultureCode) != "en")
{
    <script type="text/javascript" src="@(remoteParam.EngineURL)@DNNrocketUtils.AppendFileModifiedDate("/DesktopModules/DNNrocket/js/localization/messages_" + DNNrocketUtils.GetCurrentLanguageCode() + ".js")"></script>
}

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.0/css/all.css" integrity="sha384-lZN37f5QGtY3VHgisS14W3ExzMWZxybE1SJSEsQp9S+oqd12jhcu+A56Ebc1zFSJ" crossorigin="anonymous">

<script>

    $(document).ready(function () {
        $(document).simplisityStartUp('@(portalShop.EngineUrlWithProtocol)/Desktopmodules/dnnrocket/api/rocket/action', { systemkey: 'rocketecommerce', debug: false });

        @{
            // THESE VALUES ARE NEEDED FOR REMOTE RENDERING, POPULATE THEM ON FIRST LOAD (In the module OnInit(EventArgs e)),
            //  THEN ADD THEM TO SESSIONPARAMS SO THEY ARE AVAILABLE FOR REMOTE SERVER RENDERING.
        }
        simplisity_setSessionField("pageurl", '@remoteParam.RemotePageUrl');
        simplisity_setSessionField("sitekey", '@remoteParam.RemoteSiteKey');
        simplisity_setSessionField('remotecall', 'True');
        simplisity_setSessionField('remotelanguage', '@remoteParam.CultureCode');

    });

    function validatePayment() {

        var form = $("#Form");
        form.validate({
            rules: {
                email: {
                    required: true,
                    email: true
                },
            },
            errorPlacement: function () {
                return false;  // suppresses error message text
            },
            invalidHandler: function (e, validator) {
                $('input').removeClass('w3-pale-red');
                $('input').removeClass('w3-border-red');
                for (var i in validator.errorMap) {
                    $('#' + i).addClass('w3-pale-red');
                    $('#' + i).addClass('w3-border-red')
                }
            },
            amount: {
                required: true,
                digits: true
            },
        });
        if (!form.valid()) {
            $('.dovalidate').attr('s-stop', 'stop')
        }
    }

    function updateQty(productid, addvalue) {
        var qty = parseInt($('#qty' + productid).val());
        var newqty = qty + addvalue;
        if (newqty < 1) newqty = 1;
        $('#qty' + productid).val(newqty);
    }

    function beforebuy() {
            $('.w3-modal').hide();
    }
    function afterbuy() {
        minicartdisplay();
    }
    function showproductmodel(productid) {
        $('#qty' + productid).val('1');
        document.getElementById('productmodelid' + productid).style.display='block'
    }

    function popupImage(element) {
        document.getElementById("imgPopup").src = $(element).attr("popupsrc");
        document.getElementById("modalimgPopup").style.display = "block";
    }

    function simplisitypanelecommercetag() {
       $('#ecommerce-tag').activateSimplisityPanel('@(portalShop.EngineUrlWithProtocol)/Desktopmodules/dnnrocket/api/rocket/action')
    }

    @*function minicartdisplay() {
        // update the cart display.
        // If this is a remote module, it will NOT know the "browserid" and therefore we need to call the cart update from the browser.
        // When we call it on page load, we pass the browserid, through simplisityJS.  This allows us to get the cart data.
        // After the call return, we activate the simplisity panel, to make the page work correctly.
        $('#minicartdisplay').getSimplisity('@(portalShop.EngineUrlWithProtocol)/Desktopmodules/dnnrocket/api/rocket/action', 'rocketecommerce_minicart', '{"systemkey":"rocketecommerce","template":"minicart.cshtml"}', "simplisitypanelecommercetag");
    }*@

    function firstLoadMove() {
        var toastedfirstload = sessionStorage.getItem("toastedfirstload");
        if (toastedfirstload !== 'false') {
            $('html, body').animate({
                scrollTop: $('.productlist').offset().top
            }, 500, function () {
            });
        }
        sessionStorage.setItem("toastedfirstload", "false");
    }

    function altersearchurl() {
        const nextURL = '@sessionParams.PageUrl';
        const nextTitle = '';
        const nextState = { additionalInformation: 'search' };
        window.history.pushState(nextState, nextTitle, nextURL);
    }

</script>
